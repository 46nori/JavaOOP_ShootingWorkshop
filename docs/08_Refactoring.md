# Step 8: リファクタリング (Refactoring)

これまでのステップでは「オブジェクト指向」という**考え方**を学んできましたが、このステップで学ぶ「リファクタリング」は、プログラミングをする上での**重要なテクニック**です。
オブジェクト指向とは直接関係ありませんが、良いソフトウェアを作るためには欠かせないスキルです。

## 🧹 リファクタリングとは？

リファクタリングとは、**「プログラムの動き（機能）は変えずに、中身のコードを整理してきれいにすること」**です。

例えるなら、**「部屋の片付け」**に似ています。
散らかった部屋でも生活はできますが、探し物が見つからなかったり、足の踏み場がなかったりして不便ですよね？
定期的に片付けをして整理整頓しておけば、快適に過ごせますし、新しい家具を置くスペースもすぐに作れます。

プログラムも同じです。
「動けばいいや」と汚いコードのまま放置しておくと、後で機能を追加したりバグを直したりするときに、どこを触ればいいか分からなくなってしまいます（これを「スパゲッティコード」と呼びます）。

### 定期的に行うメリット

リファクタリングをこまめに行うことで、以下のような効果があります。
1.  **読みやすくなる**: 他の人（や未来の自分）が見ても、すぐに意味がわかるようになります。
2.  **変更しやすくなる**: 整理されているので、新しい機能を追加するのが簡単になります（保守性の向上）。
3.  **バグが減る**: コードがシンプルになるので、間違いに気づきやすくなります（品質の向上）。

Step 7のコードを題材に、よりプロフェッショナルな品質に改善してみましょう。

## 🔍 改善ポイント

### 1. マジックナンバーの排除

コードの中に突然現れる `800` や `600` などの数字を「マジックナンバー」と呼びます。
これらは「画面の幅かな？」と推測はできますが、後で変更したい時に全ての数字を探して書き換えるのは大変ですし、間違いのもとです。

**改善前:**

```java
if (x > 800) x = 0;
```

**改善後 (定数の利用):**

```java
// 名前がついているので意味が明確！変更もここだけでOK。
public static final int WINDOW_WIDTH = 800;

// ...

if (x > WINDOW_WIDTH) x = 0;
```

> **☕ コラム：public static final ってなに？**
> 定数を作るときによく使われるこの3つのキーワードには、それぞれ意味があります。
>
> - **public**: 「どこからでも使えるよ」
>   - 他のクラス（GameMainなど）からも `Enemy.WINDOW_WIDTH` としてアクセスできるようにします。
> - **static**: 「クラスに1つだけだよ」
>   - インスタンス（敵1体1体）ごとに持つ必要はなく、クラス全体で共有する値です。
> - **final**: 「変更できないよ」
>   - 一度決めたら書き換えられないようにします（これが「定数」たる所以です）。
>
> これらを組み合わせることで、「誰でも参照できるけど、誰も書き換えられない、クラス共通の決まり事」を作ることができます。

### 2. Setterにロジックを追加

Step 7のSetterは値を代入するだけでしたが、カプセル化の真価は「不正な値を防ぐ」ことにあります。

**改善前:**

```java
public void setX(double x) {
    this.x = x; // -9999 でも入ってしまう
}
```

**改善後 (バリデーション):**

```java
public void setX(double x) {
    if (x < 0) {
        this.x = 0; // 画面外に行かないように補正
    } else {
        this.x = x;
    }
}
```

### 3. メソッドの抽出 (Extract Method)

`main` ループの中に `try-catch` のような複雑な記述があると、本来やりたいこと（移動・描画）が見えにくくなります。
細かい処理は別のメソッドに切り出す（抽出する）ことで、コードが読みやすくなります。

**改善前:**

```java
while (true) {
    try {
        // ...
        Thread.sleep(16);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}
```

**改善後:**

```java
while (true) {
    // ...
    sleep(); // 何をしているか一目瞭然！
}

// 詳細はこっちに隠す
private void sleep() {
    try {
        Thread.sleep(16);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}
```

## 実行方法

Eclipse上で `src/step08_refactoring/GameMain.java` を右クリックし、**[Run As]** > **[Java Application]** を選択します。
動きはStep 7と全く同じはずです。しかし、コードの品質（読みやすさ、変更しやすさ、安全性）は大きく向上しています。


次は [応用編: 物理演算シミュレーション (Advanced Challenge)](09_AdvancedChallenge.md) です。
